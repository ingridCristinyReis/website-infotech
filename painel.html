<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InfoTech - Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      background: radial-gradient(circle at center, #0f172a 0%, #020617 100%);
      color: #fff;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 240px;
      background: rgba(30,41,59,0.95);
      color: #fff;
      display: flex;
      flex-direction: column;
      padding: 15px;
      transition: all 0.3s ease;
    }

    .sidebar h2 {
      margin: 0 0 20px;
      font-size: 18px;
      text-align: center;
      letter-spacing: 1px;
    }

    .sidebar input {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: none;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
    }

    .sidebar ul li {
      margin: 8px 0;
    }

    .sidebar ul li a {
      color: #fff;
      text-decoration: none;
      display: block;
      padding: 10px;
      border-radius: 6px;
      transition: background 0.3s;
    }

    .sidebar ul li a:hover {
      background: #334155;
    }

    .settings {
      margin-top: auto;
      border-top: 1px solid rgba(255,255,255,0.2);
      padding-top: 10px;
    }

    .settings button {
      background: none;
      border: none;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      padding: 10px;
      width: 100%;
      text-align: left;
    }

    .dropdown-content {
      display: none;
      flex-direction: column;
      background: #334155;
      margin-top: 5px;
      border-radius: 6px;
      overflow: hidden;
    }

    .dropdown-content a {
      color: #fff;
      text-decoration: none;
      padding: 10px;
      font-size: 14px;
    }

    .dropdown-content a:hover {
      background: #475569;
    }

    .show {
      display: flex;
    }

    /* Conte√∫do */
    .content {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow-y: auto;
    }

    .cards {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    .card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 12px 10px;
      flex: 1 1 200px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      max-width: 300px;
      min-width: 220px;
      height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .card h3 {
      margin: 0 0 8px;
      font-size: 16px;
      color: #f1f5f9;
    }

    .card p {
      margin: 0;
      font-size: 22px;
      font-weight: bold;
      color: #38bdf8;
    }

    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
    }

    .chart-box {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      min-height: 220px;
    }

    .chart-box canvas {
      max-height: 240px;
    }

    .problems {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
      max-height: 260px;
      overflow-y: auto;
    }

    .problems::-webkit-scrollbar {
      width: 8px;
    }
    .problems::-webkit-scrollbar-thumb {
      background-color: rgba(255,255,255,0.3);
      border-radius: 4px;
    }
    .problems::-webkit-scrollbar-thumb:hover {
      background-color: rgba(255,255,255,0.5);
    }

    .problem-card {
      background: rgba(0, 0, 0, 0.4);
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>INFOTECH</h2>
    <input type="text" placeholder="Procurar">

    <ul>
      <li><a href="painel.html">Painel Dashboard</a></li>
      <li><a href="chamados.html">Chamados</a></li>
      <li><a href="relatorio.html">Relat√≥rios</a></li>
      <li><a href="tecnico.html">T√©cnicos</a></li>
      <li><a href="#">Ajuda</a></li>
    </ul>

    <div class="settings">
      <button onclick="toggleDropdown()">‚öô Ajustes</button>
      <div id="settingsDropdown" class="dropdown-content">
        <a href="#" onclick="toggleLanguage()">üåê Mudar idioma</a>
        <a onclick="logout()">Encerrar sess√£o</a>
      </div>
    </div>
  </div>

  <div class="content">
    <h1>Bem-vindo ao Painel</h1>
    <p>Aqui voc√™ pode acompanhar seus chamados, relat√≥rios e t√©cnicos.</p>

    <div class="cards">
      <div class="card">
        <h3>Meus chamados</h3>
        <p id="meusChamados">0</p>
      </div>
      <div class="card">
        <h3>Conclu√≠dos hoje</h3>
        <p id="concluidosHoje">0</p>
      </div>
    </div>

    <div class="charts">
      <div class="chart-box">
        <h3>Chamados √∫ltimos 7 dias</h3>
        <canvas id="chartChamados"></canvas>
      </div>
      <div class="chart-box">
        <h3>Status dos chamados</h3>
        <canvas id="chartDepto"></canvas>
      </div>
    </div>

    <div class="problems">
      <h3>Problemas recentes</h3>
      <p>Carregando...</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const usuario = JSON.parse(sessionStorage.getItem("usuario")) || JSON.parse(localStorage.getItem("usuario"));
    if (!usuario) {
      alert("Sess√£o expirada. Fa√ßa login novamente.");
      window.location.href = "index.html";
    }

    document.querySelector("h1").textContent = `Bem-vindo, ${usuario.nomeUsuario || "Usu√°rio"}!`;

    let chartChamados = null;

    async function carregarChamados() {
      try {
        // üß© Mostra a URL que est√° sendo chamada
        const url = `http://localhost:5018/api/Chamados`;
        console.log("üîç Buscando:", url);

        const response = await fetch(url);
        console.log("üì¶ Status:", response.status);

        if (!response.ok) throw new Error(`Erro HTTP ${response.status}`);

        const chamados = await response.json();
        console.log("‚úÖ Dados recebidos:", chamados);

        // Atualiza cards
        document.getElementById("meusChamados").textContent = chamados.length;
        const hoje = new Date().toISOString().split("T")[0];
        const concluidosHoje = chamados.filter(c =>
          c.status?.toLowerCase() === "concluido" &&
          c.dataFechamento &&
          c.dataFechamento.startsWith(hoje)
      );
        document.getElementById("concluidosHoje").textContent = concluidosHoje.length;

        // Atualiza gr√°ficos e lista
        atualizarGraficoChamados(chamados);
        atualizarGraficoStatus(chamados);
        preencherProblemas(chamados);

      } catch (error) {
        console.error("‚ùå Erro ao carregar chamados:", error);
        alert("N√£o foi poss√≠vel carregar os chamados.\nVerifique se a API est√° rodando e o endpoint est√° correto.");
      }
    }

    function preencherProblemas(chamados) {
      const container = document.querySelector(".problems");
      container.innerHTML = "<h3>Problemas recentes</h3>";

      if (chamados.length === 0) {
        container.innerHTML += "<p>Nenhum chamado encontrado.</p>";
        return;
      }

      chamados.slice(-5).reverse().forEach(c => {
  const div = document.createElement("div");
  div.className = "problem-card";

  // Formata datas (deixa leg√≠vel no padr√£o brasileiro)
  const dataAbertura = c.dataAbertura
    ? new Date(c.dataAbertura).toLocaleString("pt-BR", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
      })
    : "‚Äî";

  const dataFechamento = c.dataFechamento
    ? new Date(c.dataFechamento).toLocaleString("pt-BR", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
      })
    : "‚Äî";

  div.innerHTML = `
    <p><strong>ID:</strong> #${c.idChamado}</p>
    <p><strong>T√≠tulo:</strong> ${c.titulo || "‚Äî"}</p>
    <p><strong>Descri√ß√£o:</strong> ${c.descricao || "‚Äî"}</p>
    <p><strong>Prioridade:</strong> ${c.prioridade || "‚Äî"}</p>
    <p><strong>Status:</strong> ${c.status || "‚Äî"}</p>
    <p><strong>Data de abertura:</strong> ${dataAbertura}</p>
    <p><strong>Data de fechamento:</strong> ${dataFechamento}</p>
  `;
  container.appendChild(div);
});

    }
    
    function atualizarGraficoChamados(chamados) {
  const hoje = new Date();
  const dias = [];

  // Gera lista dos √∫ltimos 7 dias
  for (let i = 6; i >= 0; i--) {
    const d = new Date(hoje);
    d.setDate(d.getDate() - i);
    const label = d.toLocaleDateString("pt-BR", { weekday: "short" });
    const dataISO = d.toISOString().split("T")[0];
    dias.push({ label, data: dataISO, total: 0 });
  }

  // Conta quantos chamados foram abertos em cada dia
  chamados.forEach(c => {
    const dataAbertura = c.dataAbertura?.split("T")[0];
    const dia = dias.find(d => d.data === dataAbertura);
    if (dia) dia.total++;
  });

  const labels = dias.map(d => d.label);
  const valores = dias.map(d => d.total);
  const ctx = document.getElementById("chartChamados");

  if (chartChamados) {
    chartChamados.data.labels = labels;
    chartChamados.data.datasets[0].data = valores;
    chartChamados.update();
  } else {
    chartChamados = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "Chamados abertos",
          data: valores,
          backgroundColor: "#38bdf8"
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },

        // üí• Aqui adicionamos o clique no gr√°fico
        onClick: (event, elements) => {
          if (elements.length > 0) {
            const index = elements[0].index;
            const diaSelecionado = dias[index].data;
            filtrarChamadosPorData(chamados, diaSelecionado);
          }
        }
      }
    });
  }
}
// üîπ Nova fun√ß√£o: filtra chamados do dia clicado
function filtrarChamadosPorData(chamados, dataSelecionada) {
  const filtrados = chamados.filter(c =>
    c.dataAbertura?.startsWith(dataSelecionada)
  );

  // Atualiza contadores
  document.getElementById("meusChamados").textContent = filtrados.length;
  const concluidosDia = filtrados.filter(c => c.status?.toLowerCase() === "concluido");
  document.getElementById("concluidosHoje").textContent = concluidosDia.length;

  // Atualiza a lista de problemas
  const container = document.querySelector(".problems");
  container.innerHTML = `
    <h3>Chamados de ${new Date(dataSelecionada).toLocaleDateString("pt-BR")}
      <button onclick="carregarChamados()" style="
        float:right;
        background:#38bdf8;
        border:none;
        color:#fff;
        border-radius:6px;
        padding:4px 8px;
        cursor:pointer;
      ">Voltar</button>
    </h3>
  `;

  if (filtrados.length === 0) {
    container.innerHTML += "<p>Nenhum chamado encontrado neste dia.</p>";
    return;
  }

  filtrados.reverse().forEach(c => {
    const dataAbertura = new Date(c.dataAbertura).toLocaleString("pt-BR", {
      day: "2-digit", month: "2-digit", year: "numeric",
      hour: "2-digit", minute: "2-digit"
    });
    const dataFechamento = c.dataFechamento
      ? new Date(c.dataFechamento).toLocaleString("pt-BR", {
          day: "2-digit", month: "2-digit", year: "numeric",
          hour: "2-digit", minute: "2-digit"
        })
      : "‚Äî";

    const div = document.createElement("div");
    div.className = "problem-card";
    div.innerHTML = `
      <p><strong>ID:</strong> #${c.idChamado}</p>
      <p><strong>T√≠tulo:</strong> ${c.titulo || "‚Äî"}</p>
      <p><strong>Descri√ß√£o:</strong> ${c.descricao || "‚Äî"}</p>
      <p><strong>Prioridade:</strong> ${c.prioridade || "‚Äî"}</p>
      <p><strong>Status:</strong> ${c.status || "‚Äî"}</p>
      <p><strong>Data de abertura:</strong> ${dataAbertura}</p>
      <p><strong>Data de fechamento:</strong> ${dataFechamento}</p>
    `;
    container.appendChild(div);
  });
}

    // üîπ Gr√°fico de status (pizza)
    function atualizarGraficoStatus(chamados) {
      const ctx = document.getElementById("chartDepto");
      const statusCount = {};
      chamados.forEach(c => {
        const status = c.status || "Indefinido";
        statusCount[status] = (statusCount[status] || 0) + 1;
      });

      new Chart(ctx, {
        type: "pie",
        data: {
          labels: Object.keys(statusCount),
          datasets: [{
            data: Object.values(statusCount),
            backgroundColor: ["#0ea5e9", "#22c55e", "#f97316", "#e11d48"]
          }]
        },
        options: { responsive: true, plugins: { legend: { position: "bottom" } } }
      });
    }

    function toggleDropdown() {
      document.getElementById("settingsDropdown").classList.toggle("show");
    }

    function logout() {
      localStorage.removeItem("usuario");
      localStorage.removeItem("keepLogin");
      localStorage.setItem("forceLogout", "true");
      window.location.href = "index.html";
    }

    carregarChamados();
  </script>
</body>
</html>
